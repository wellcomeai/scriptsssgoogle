/******************************************************
 * TelegramLeadNotifier.gs
 * –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –∞–Ω–∞–ª–∏–∑–æ–≤ –æ—Ç –ò–ò –≤ Telegram –∏ Email
 * –í–ê–ñ–ù–û: –§—É–Ω–∫—Ü–∏—è onOpen() —É–¥–∞–ª–µ–Ω–∞ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ —Å main.gs
 * –ú–µ–Ω—é –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ main.gs
 ******************************************************/

/**
 * –ö–û–ù–°–¢–ê–ù–¢–´ –î–õ–Ø TELEGRAM BOT
 */
var TELEGRAM_BOT_TOKEN = "8372070218:AAEZrSDVJ4kqUm5QYIRtPp8b7qTGB7Mt_7Y";
var TELEGRAM_CHAT_ID = "-4109810158";

/**
 * –ö–û–ù–°–¢–ê–ù–¢–´ –î–õ–Ø EMAIL
 */
var EMAIL_ADDRESS = "kihcgnca165v24hr31av@task.yougile.com";
var EMAIL_SUBJECT = "–¢–µ–∫—Å—Ç–æ–≤—ã–π –ò–ò –Ω–æ–≤–∞—è –∑–∞—è–≤–∫–∞";

/**
 * –ö–û–ù–°–¢–ê–ù–¢–´ –î–õ–Ø –û–ë–†–ê–ë–û–¢–ö–ò –°–û–û–ë–©–ï–ù–ò–ô
 */
var TELEGRAM_MAX_LENGTH = 4096;
var TELEGRAM_SAFE_LENGTH = 4000; // –û—Å—Ç–∞–≤–ª—è–µ–º –∑–∞–ø–∞—Å –¥–ª—è —Ç–µ–∫—Å—Ç–∞ –æ–± –æ–±—Ä–µ–∑–∫–µ

/**
 * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram —á–µ—Ä–µ–∑ Bot API
 * –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–µ–∑–∞–µ—Ç —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
 * @param {string} message - —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
 * @param {string} cellAddress - –∞–¥—Ä–µ—Å —è—á–µ–π–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä "B15") –¥–ª—è —É–∫–∞–∑–∞–Ω–∏—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
 * @return {boolean} true –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ, false –µ—Å–ª–∏ –æ—à–∏–±–∫–∞
 */
function sendToTelegram(message, cellAddress) {
  // –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê: —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—É—Å—Ç—ã–º
  if (!message || message.toString().trim() === "") {
    Logger.log("‚ùå –û–®–ò–ë–ö–ê: –ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram!");
    return false;
  }
  
  var originalMessage = message.toString().trim();
  var messageToSend = originalMessage;
  var messageLength = originalMessage.length;
  
  Logger.log("üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram, –¥–ª–∏–Ω–∞: " + messageLength + " —Å–∏–º–≤–æ–ª–æ–≤");
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –æ–±—Ä–µ–∑–∞–µ–º –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
  if (messageLength > TELEGRAM_MAX_LENGTH) {
    Logger.log("‚ö†Ô∏è –°–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ (" + messageLength + " —Å–∏–º–≤–æ–ª–æ–≤), –æ–±—Ä–µ–∑–∞–µ–º –¥–æ " + TELEGRAM_SAFE_LENGTH);
    
    // –û–±—Ä–µ–∑–∞–µ–º –¥–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –¥–ª–∏–Ω—ã
    messageToSend = originalMessage.substring(0, TELEGRAM_SAFE_LENGTH);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ–±—Ä–µ–∑–∫–µ –∏ –º–µ—Å—Ç–æ–Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–∏ –ø–æ–ª–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
    var truncateInfo = "\n\n‚ö†Ô∏è –î–∏–∞–ª–æ–≥ –æ–±—Ä–µ–∑–∞–Ω (—Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π)\nüìç –ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ —è—á–µ–π–∫–µ: " + cellAddress;
    messageToSend += truncateInfo;
    
    Logger.log("‚úÇÔ∏è –°–æ–æ–±—â–µ–Ω–∏–µ –æ–±—Ä–µ–∑–∞–Ω–æ, –Ω–æ–≤–∞—è –¥–ª–∏–Ω–∞: " + messageToSend.length + " —Å–∏–º–≤–æ–ª–æ–≤");
  }
  
  var url = "https://api.telegram.org/bot" + TELEGRAM_BOT_TOKEN + "/sendMessage";
  
  var payload = {
    chat_id: TELEGRAM_CHAT_ID,
    text: messageToSend,
    parse_mode: "HTML"
  };
  
  var options = {
    method: "post",
    contentType: "application/json",
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };
  
  try {
    var response = UrlFetchApp.fetch(url, options);
    var responseCode = response.getResponseCode();
    var responseText = response.getContentText();
    
    if (responseCode === 200) {
      Logger.log("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram");
      return true;
    } else {
      Logger.log("‚ùå –û—à–∏–±–∫–∞ Telegram API: " + responseCode + " - " + responseText);
      return false;
    }
  } catch (error) {
    Logger.log("‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ Telegram: " + error.message);
    return false;
  }
}

/**
 * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ Email —á–µ—Ä–µ–∑ MailApp
 * @param {string} message - —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ (–ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π)
 * @return {boolean} true –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ, false –µ—Å–ª–∏ –æ—à–∏–±–∫–∞
 */
function sendToEmail(message) {
  // –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê: —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—É—Å—Ç—ã–º
  if (!message || message.toString().trim() === "") {
    Logger.log("‚ùå –û–®–ò–ë–ö–ê: –ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ Email!");
    return false;
  }
  
  Logger.log("üìß –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ Email: " + EMAIL_ADDRESS);
  
  try {
    MailApp.sendEmail({
      to: EMAIL_ADDRESS,
      subject: EMAIL_SUBJECT,
      body: message.toString().trim()
    });
    
    Logger.log("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ Email");
    return true;
  } catch (error) {
    Logger.log("‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –Ω–∞ Email: " + error.message);
    return false;
  }
}

/**
 * –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ª–∏–¥–æ–≤ –≤ Telegram –∏ Email
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Å–µ —è—á–µ–π–∫–∏ –ª–∏—Å—Ç–∞ "–î–∏–∞–ª–æ–≥–∏" –Ω–∞—á–∏–Ω–∞—è —Å B2
 * –ò—â–µ—Ç —è—á–µ–π–∫–∏ —Å –º–∞—Ä–∫–µ—Ä–æ–º "ü§ñ –ê–ù–ê–õ–ò–ó –û–¢ –ò–ò" –±–µ–∑ –æ—Ç–º–µ—Ç–∫–∏ "–õ–ò–î –û–¢–ü–†–ê–í–õ–ï–ù"
 */
function scanAndSendLeadsToTelegram() {
  Logger.log("=== –ù–∞—á–∞–ª–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ª–∏–¥–æ–≤ –¥–ª—è Telegram –∏ Email ===");
  
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var dialogSheet = ss.getSheetByName("–î–∏–∞–ª–æ–≥–∏");
  
  if (!dialogSheet) {
    Logger.log("‚ùå –õ–∏—Å—Ç '–î–∏–∞–ª–æ–≥–∏' –Ω–µ –Ω–∞–π–¥–µ–Ω!");
    return;
  }
  
  var lastRow = dialogSheet.getLastRow();
  var lastCol = dialogSheet.getLastColumn();
  
  Logger.log("üìä –†–∞–∑–º–µ—Ä—ã –ª–∏—Å—Ç–∞: " + lastRow + " —Å—Ç—Ä–æ–∫, " + lastCol + " –∫–æ–ª–æ–Ω–æ–∫");
  
  // –°—á–µ—Ç—á–∏–∫–∏ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
  var leadsFound = 0;
  var leadsSent = 0;
  var leadsSkipped = 0;
  var leadsError = 0;
  
  // –°–∫–∞–Ω–∏—Ä—É–µ–º –≤—Å–µ —è—á–µ–π–∫–∏ –Ω–∞—á–∏–Ω–∞—è —Å B2 (–∫–æ–ª–æ–Ω–∫–∞ 2, —Å—Ç—Ä–æ–∫–∞ 2)
  for (var row = 2; row <= lastRow; row++) {
    for (var col = 2; col <= lastCol; col++) {
      var cell = dialogSheet.getRange(row, col);
      var cellValue = cell.getValue();
      
      // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏
      if (!cellValue || cellValue.toString().trim() === "") {
        continue;
      }
      
      var cellText = cellValue.toString();
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –º–∞—Ä–∫–µ—Ä–∞ "ü§ñ –ê–ù–ê–õ–ò–ó –û–¢ –ò–ò"
      if (cellText.indexOf("ü§ñ –ê–ù–ê–õ–ò–ó –û–¢ –ò–ò") === -1) {
        continue;
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ª–∏ —É–∂–µ –ª–∏–¥
      if (cellText.indexOf("–õ–ò–î –û–¢–ü–†–ê–í–õ–ï–ù") !== -1) {
        leadsSkipped++;
        continue;
      }
      
      // –ù–∞–π–¥–µ–Ω –ª–∏–¥ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏!
      leadsFound++;
      
      // –ü–æ–ª—É—á–∞–µ–º –∞–¥—Ä–µ—Å —è—á–µ–π–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ A1 (–Ω–∞–ø—Ä–∏–º–µ—Ä "B15")
      var cellAddress = cell.getA1Notation();
      Logger.log("üéØ –ù–∞–π–¥–µ–Ω –ª–∏–¥ –≤ —è—á–µ–π–∫–µ " + cellAddress);
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram (—Å –æ–±—Ä–µ–∑–∫–æ–π –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
      var telegramSuccess = sendToTelegram(cellText, cellAddress);
      
      // –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É –æ—Ç–ø—Ä–∞–≤–∫–∞–º–∏
      Utilities.sleep(500);
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ Email (–ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç)
      var emailSuccess = sendToEmail(cellText);
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∏
      if (telegramSuccess && emailSuccess) {
        // –£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –æ–±–∞ –∫–∞–Ω–∞–ª–∞ - –¥–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –≤ –Ω–∞—á–∞–ª–æ
        var leadSentMarker = "‚úÖ –õ–ò–î –û–¢–ü–†–ê–í–õ–ï–ù\n\n";
        var newCellText = leadSentMarker + cellText;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —è—á–µ–π–∫—É
        cell.setValue(newCellText);
        
        // –î–µ–ª–∞–µ–º —Ç–µ–∫—Å—Ç –º–∞—Ä–∫–µ—Ä–∞ –∂–∏—Ä–Ω—ã–º
        var markerLength = leadSentMarker.length;
        var richText = SpreadsheetApp.newRichTextValue()
          .setText(newCellText)
          .setTextStyle(0, markerLength, SpreadsheetApp.newTextStyle().setBold(true).build())
          .build();
        cell.setRichTextValue(richText);
        
        leadsSent++;
        Logger.log("‚úÖ –õ–∏–¥ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram –∏ Email, –ø–æ–º–µ—á–µ–Ω –≤ —è—á–µ–π–∫–µ " + cellAddress);
      } else if (telegramSuccess || emailSuccess) {
        // –ß–∞—Å—Ç–∏—á–Ω—ã–π —É—Å–ø–µ—Ö
        leadsError++;
        Logger.log("‚ö†Ô∏è –õ–∏–¥ —á–∞—Å—Ç–∏—á–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω (Telegram: " + telegramSuccess + ", Email: " + emailSuccess + ") –∏–∑ —è—á–µ–π–∫–∏ " + cellAddress);
      } else {
        // –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ –æ–±–∞ –∫–∞–Ω–∞–ª–∞
        leadsError++;
        Logger.log("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ª–∏–¥–∞ –∏–∑ —è—á–µ–π–∫–∏ " + cellAddress);
      }
      
      // –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º –ª–∏–¥–æ–º
      Utilities.sleep(500);
    }
  }
  
  // –õ–æ–≥–∏—Ä—É–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
  Logger.log("=== –ò—Ç–æ–≥–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è ===");
  Logger.log("üîç –ù–∞–π–¥–µ–Ω–æ –ª–∏–¥–æ–≤: " + leadsFound);
  Logger.log("‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: " + leadsSent);
  Logger.log("‚è≠Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ (—É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã): " + leadsSkipped);
  Logger.log("‚ùå –û—à–∏–±–æ–∫: " + leadsError);
  Logger.log("=== –ö–æ–Ω–µ—Ü —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è ===");
}

/**
 * –°–æ–∑–¥–∞–µ—Ç —Ç—Ä–∏–≥–≥–µ—Ä –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
 * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
 */
function createTelegramNotifierTrigger() {
  // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
  removeTelegramNotifierTrigger();
  
  // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Ç—Ä–∏–≥–≥–µ—Ä
  ScriptApp.newTrigger("scanAndSendLeadsToTelegram")
    .timeBased()
    .everyMinutes(1)
    .create();
  
  Logger.log("‚úÖ –¢—Ä–∏–≥–≥–µ—Ä –¥–ª—è Telegram –∏ Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Å–æ–∑–¥–∞–Ω (–∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É)");
  SpreadsheetApp.getUi().alert(
    "Telegram –∏ Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã",
    "–°–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ª–∏—Å—Ç '–î–∏–∞–ª–æ–≥–∏' –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É\n" +
    "–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –∞–Ω–∞–ª–∏–∑—ã –æ—Ç –ò–ò –≤ Telegram –≥—Ä—É–ø–ø—É –∏ –Ω–∞ Email.",
    SpreadsheetApp.getUi().ButtonSet.OK
  );
}

/**
 * –£–¥–∞–ª—è–µ—Ç —Ç—Ä–∏–≥–≥–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram –∏ Email
 * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
 */
function removeTelegramNotifierTrigger() {
  var triggers = ScriptApp.getProjectTriggers();
  var removedCount = 0;
  
  for (var i = 0; i < triggers.length; i++) {
    if (triggers[i].getHandlerFunction() === "scanAndSendLeadsToTelegram") {
      ScriptApp.deleteTrigger(triggers[i]);
      removedCount++;
    }
  }
  
  if (removedCount > 0) {
    Logger.log("üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤: " + removedCount);
    SpreadsheetApp.getUi().alert(
      "Telegram –∏ Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã",
      "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –ª–∏–¥–æ–≤ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞.",
      SpreadsheetApp.getUi().ButtonSet.OK
    );
  } else {
    Logger.log("‚ÑπÔ∏è –¢—Ä–∏–≥–≥–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã");
  }
}

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å —Ç—Ä–∏–≥–≥–µ—Ä–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
 * @return {boolean} true –µ—Å–ª–∏ —Ç—Ä–∏–≥–≥–µ—Ä –∞–∫—Ç–∏–≤–µ–Ω, false –µ—Å–ª–∏ –Ω–µ—Ç
 */
function checkTelegramNotifierStatus() {
  var triggers = ScriptApp.getProjectTriggers();
  
  for (var i = 0; i < triggers.length; i++) {
    if (triggers[i].getHandlerFunction() === "scanAndSendLeadsToTelegram") {
      return true;
    }
  }
  
  return false;
}

/**
 * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å —Ç—Ä–∏–≥–≥–µ—Ä–∞
 */
function showTelegramNotifierStatus() {
  var isActive = checkTelegramNotifierStatus();
  var status = isActive ? "‚úÖ –ê–ö–¢–ò–í–ï–ù" : "‚ùå –ù–ï–ê–ö–¢–ò–í–ï–ù";
  
  SpreadsheetApp.getUi().alert(
    "–°—Ç–∞—Ç—É—Å Telegram –∏ Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π",
    "–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å: " + status + "\n\n" +
    (isActive ? 
      "–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫–∞–Ω–∏—Ä—É–µ—Ç –ª–∏—Å—Ç –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É." : 
      "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω—é –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏."),
    SpreadsheetApp.getUi().ButtonSet.OK
  );
}

/**
 * –¢–µ—Å—Ç–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram
 * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
 */
function testTelegramConnection() {
  Logger.log("üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Telegram...");
  
  var testMessage = 
    "üß™ –¢–ï–°–¢–û–í–û–ï –°–û–û–ë–©–ï–ù–ò–ï\n\n" +
    "–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç Google Sheets —Å–∫—Ä–∏–ø—Ç–∞.\n" +
    "–ï—Å–ª–∏ –≤—ã –≤–∏–¥–∏—Ç–µ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∑–Ω–∞—á–∏—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Telegram —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ! ‚úÖ\n\n" +
    "–í—Ä–µ–º—è: " + new Date().toString();
  
  var success = sendToTelegram(testMessage, "TEST");
  
  if (success) {
    SpreadsheetApp.getUi().alert(
      "–¢–µ—Å—Ç Telegram —É—Å–ø–µ—à–µ–Ω! ‚úÖ",
      "–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram –≥—Ä—É–ø–ø—É.\n" +
      "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≥—Ä—É–ø–ø—É —Å ID: " + TELEGRAM_CHAT_ID,
      SpreadsheetApp.getUi().ButtonSet.OK
    );
  } else {
    SpreadsheetApp.getUi().alert(
      "–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞ Telegram ‚ùå",
      "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram.\n" +
      "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:\n" +
      "1. –¢–æ–∫–µ–Ω –±–æ—Ç–∞ –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω\n" +
      "2. –ë–æ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≥—Ä—É–ø–ø—É –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä\n" +
      "3. ID –≥—Ä—É–ø–ø—ã —É–∫–∞–∑–∞–Ω –≤–µ—Ä–Ω–æ",
      SpreadsheetApp.getUi().ButtonSet.OK
    );
  }
}

/**
 * –¢–µ—Å—Ç–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ Email
 * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
 */
function testEmailConnection() {
  Logger.log("üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ Email...");
  
  var testMessage = 
    "üß™ –¢–ï–°–¢–û–í–û–ï –°–û–û–ë–©–ï–ù–ò–ï\n\n" +
    "–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç Google Sheets —Å–∫—Ä–∏–ø—Ç–∞.\n" +
    "–ï—Å–ª–∏ –≤—ã –≤–∏–¥–∏—Ç–µ —ç—Ç–æ –ø–∏—Å—å–º–æ, –∑–Ω–∞—á–∏—Ç –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ Email —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ! ‚úÖ\n\n" +
    "–í—Ä–µ–º—è: " + new Date().toString();
  
  var success = sendToEmail(testMessage);
  
  if (success) {
    SpreadsheetApp.getUi().alert(
      "–¢–µ—Å—Ç Email —É—Å–ø–µ—à–µ–Ω! ‚úÖ",
      "–¢–µ—Å—Ç–æ–≤–æ–µ –ø–∏—Å—å–º–æ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –∞–¥—Ä–µ—Å:\n" + EMAIL_ADDRESS + "\n\n" +
      "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É (–≤–æ–∑–º–æ–∂–Ω–æ –≤ –ø–∞–ø–∫–µ –°–ø–∞–º).",
      SpreadsheetApp.getUi().ButtonSet.OK
    );
  } else {
    SpreadsheetApp.getUi().alert(
      "–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞ Email ‚ùå",
      "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ –ø–∏—Å—å–º–æ.\n" +
      "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.",
      SpreadsheetApp.getUi().ButtonSet.OK
    );
  }
}

/**
 * –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ç–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram –∏ Email
 */
function testBothConnections() {
  Logger.log("üß™ –ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Telegram –∏ Email...");
  
  var testMessage = 
    "üß™ –ö–û–ú–ü–õ–ï–ö–°–ù–û–ï –¢–ï–°–¢–û–í–û–ï –°–û–û–ë–©–ï–ù–ò–ï\n\n" +
    "–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç Google Sheets —Å–∫—Ä–∏–ø—Ç–∞.\n" +
    "–û–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –≤ Telegram –∏ –Ω–∞ Email.\n\n" +
    "–í—Ä–µ–º—è: " + new Date().toString();
  
  var telegramSuccess = sendToTelegram(testMessage, "TEST");
  Utilities.sleep(500);
  var emailSuccess = sendToEmail(testMessage);
  
  var resultMessage = "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞:\n\n";
  resultMessage += "Telegram: " + (telegramSuccess ? "‚úÖ –£—Å–ø–µ—à–Ω–æ" : "‚ùå –û—à–∏–±–∫–∞") + "\n";
  resultMessage += "Email: " + (emailSuccess ? "‚úÖ –£—Å–ø–µ—à–Ω–æ" : "‚ùå –û—à–∏–±–∫–∞");
  
  if (telegramSuccess && emailSuccess) {
    resultMessage += "\n\nüéâ –û–±–∞ –∫–∞–Ω–∞–ª–∞ —Ä–∞–±–æ—Ç–∞—é—Ç –æ—Ç–ª–∏—á–Ω–æ!";
  } else if (telegramSuccess || emailSuccess) {
    resultMessage += "\n\n‚ö†Ô∏è –û–¥–∏–Ω –∏–∑ –∫–∞–Ω–∞–ª–æ–≤ –∏–º–µ–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.";
  } else {
    resultMessage += "\n\n‚ùå –û–±–∞ –∫–∞–Ω–∞–ª–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é.";
  }
  
  SpreadsheetApp.getUi().alert(
    "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞",
    resultMessage,
    SpreadsheetApp.getUi().ButtonSet.OK
  );
}

/**
 * –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
 */
function manualScanForLeads() {
  Logger.log("üñ±Ô∏è –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...");
  scanAndSendLeadsToTelegram();
  SpreadsheetApp.getUi().alert(
    "–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ",
    "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (Ctrl+Enter –∏–ª–∏ –ü—Ä–æ—Å–º–æ—Ç—Ä > –õ–æ–≥–∏) –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.",
    SpreadsheetApp.getUi().ButtonSet.OK
  );
}

/******************************************************
 * –ö–æ–Ω–µ—Ü TelegramLeadNotifier.gs
 ******************************************************/
