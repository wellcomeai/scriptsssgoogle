/******************************************************
 * main.gs (—Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π API + –ø–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞)
 ******************************************************/

/**
 * –ü–∞—Ä—Å–∏—Ç –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ —Å—Ç—Ä–æ–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∞:
 * "from_user_id:418838097 message_id:49 –í–∞–ª–µ—Ä–∏–π –®–∏—à–∫–∏–Ω (@well_sh) ru"
 * @param {string} rawData - —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å—Ç–æ–ª–±—Ü–∞
 * @return {Object} –æ–±—ä–µ–∫—Ç —Å chatID –∏ username
 */
function parseUserData(rawData) {
  if (!rawData) {
    return { chatID: null, username: null };
  }
  
  var dataStr = rawData.toString().trim();
  var userId = dataStr.match(/from_user_id:(\d+)/);
  var username = dataStr.match(/@(\w+)/);
  
  return {
    chatID: userId ? userId[1] : null,
    username: username ? username[1] : null
  };
}

/**
 * –§–æ—Ä–º–∏—Ä—É–µ—Ç –∏—Ç–æ–≥–æ–≤—ã–π chatID —Å –Ω–∏–∫–Ω–µ–π–º–æ–º –≤ —Ñ–æ—Ä–º–∞—Ç–µ "418838097 (@well_sh)"
 * @param {string} chatID - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * @param {string} username - –Ω–∏–∫–Ω–µ–π–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–±–µ–∑ @)
 * @return {string} —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π chatID
 */
function formatChatIDWithUsername(chatID, username) {
  if (!chatID) return null;
  if (username) {
    return chatID + " (@" + username + ")";
  }
  return chatID;
}

/**
 * –û–±–Ω–æ–≤–ª—è–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–æ–≤ –∏–∑ "–õ–∏—Å—Ç1" –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ –¥–∞—Ç–∞–º –≤ –ª–∏—Å—Ç–µ "–î–∏–∞–ª–æ–≥–∏".
 */
function updateDialogHistory() {
  var startTime = new Date();
  writeLog("–ù–∞—á–∞—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–æ–≤");

  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sourceSheet = ss.getSheetByName("–õ–∏—Å—Ç1");
  if (!sourceSheet) {
    writeLog("–õ–∏—Å—Ç1 –Ω–µ –Ω–∞–π–¥–µ–Ω!", "ERROR");
    return;
  }

  var data = sourceSheet.getDataRange().getValues();
  if (data.length < 2) {
    writeLog("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ –õ–∏—Å—Ç1.", "WARNING");
    return;
  }

  var headers = data[0];
  var chatIDIndex = headers.indexOf("–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –∫–∞–Ω–∞–ª–∞ –æ–±—â–µ–Ω–∏—è");
  var userDataIndex = headers.indexOf("–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –∫–ª–∏–µ–Ω—Ç–∞");
  var clientMsgIndex = headers.indexOf("–§—Ä–∞–∑–∞ –∫–ª–∏–µ–Ω—Ç–∞");
  var botMsgIndex = headers.indexOf("–§—Ä–∞–∑–∞ –±–æ—Ç–∞");
  var timestampIndex = headers.indexOf("–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è");
  // –ö–æ–ª–æ–Ω–∫–∞ P (–∏–Ω–¥–µ–∫—Å 15) ‚Äì –æ—Ç–º–µ—Ç–∫–∞ "–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ"
  var processedIndex = 15;

  if (chatIDIndex === -1 || clientMsgIndex === -1 || botMsgIndex === -1 || timestampIndex === -1) {
    writeLog("–ù–µ –Ω–∞–π–¥–µ–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –≤ –õ–∏—Å—Ç1.", "ERROR");
    return;
  }
  
  if (userDataIndex === -1) {
    writeLog("–ù–µ –Ω–∞–π–¥–µ–Ω —Å—Ç–æ–ª–±–µ—Ü '–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –∫–ª–∏–µ–Ω—Ç–∞'. –ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ '–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –∫–∞–Ω–∞–ª–∞ –æ–±—â–µ–Ω–∏—è'.", "WARNING");
  }

  // –°–µ—Å—Å–∏–∏, —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ chatID (—Å –Ω–∏–∫–Ω–µ–π–º–æ–º)
  var sessions = {};
  for (var i = 1; i < data.length; i++) {
    var row = data[i];
    var rawChatID = row[chatIDIndex];
    
    // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å chatID –∏ –Ω–∏–∫–Ω–µ–π–º –∏–∑ —Å—Ç–æ–ª–±—Ü–∞ "–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –∫–ª–∏–µ–Ω—Ç–∞"
    var finalChatID = null;
    if (userDataIndex !== -1 && row[userDataIndex]) {
      var userData = parseUserData(row[userDataIndex]);
      if (userData.chatID) {
        finalChatID = formatChatIDWithUsername(userData.chatID, userData.username);
        writeLog("–†–∞—Å–ø–∞—Ä—Å–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ: chatID=" + userData.chatID + ", username=" + userData.username, "DEBUG");
      }
    }
    
    // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–∑ –Ω–æ–≤–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—ã–π chatID
    if (!finalChatID && rawChatID) {
      finalChatID = cleanChatID(rawChatID);
    }
    
    if (!finalChatID) continue;

    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç—Ä–æ–∫–∏, –≥–¥–µ —É–∂–µ —Å—Ç–æ–∏—Ç –æ—Ç–º–µ—Ç–∫–∞ –≤ –∫–æ–ª–æ–Ω–∫–µ P
    var processed = row[processedIndex];
    if (processed && processed.toString().trim() !== "") continue;

    // –î–∞—Ç–∞ (–≤ —Ñ–æ—Ä–º–∞—Ç–µ dd.MM.yyyy)
    var ts = new Date(row[timestampIndex]);
    var dateStr = Utilities.formatDate(ts, ss.getSpreadsheetTimeZone(), "dd.MM.yyyy");

    if (!sessions[finalChatID]) {
      sessions[finalChatID] = { dates: {}, rows: [] };
    }
    if (!sessions[finalChatID].dates[dateStr]) {
      sessions[finalChatID].dates[dateStr] = [];
    }

    sessions[finalChatID].dates[dateStr].push({
      timestamp: row[timestampIndex],
      client: row[clientMsgIndex] || "",
      bot: row[botMsgIndex] || ""
    });

    // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –Ω–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏
    sessions[finalChatID].rows.push(i + 1);
  }

  var sessionsProcessed = 0;
  for (var finalChatID in sessions) {
    var session = sessions[finalChatID];
    var newData = {};

    for (var dateStr in session.dates) {
      var messages = session.dates[dateStr];
      messages.sort(function(a, b) {
        return new Date(a.timestamp) - new Date(b.timestamp);
      });
      var dialog = "";
      for (var j = 0; j < messages.length; j++) {
        dialog += "[" + messages[j].timestamp + "] –ö–ª–∏–µ–Ω—Ç: " + messages[j].client + "\n–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç: " + messages[j].bot + "\n\n";
      }
      newData[dateStr] = dialog.trim();
    }
    updateDialogSheetForChatID(finalChatID, newData);

    // –ü–æ–º–µ—á–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –∫–∞–∫ "–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ"
    for (var r = 0; r < session.rows.length; r++) {
      sourceSheet.getRange(session.rows[r], processedIndex + 1).setValue("–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ");
    }
    sessionsProcessed++;
  }

  // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  var dialogSheet = getDialogSheet();
  var now = new Date();
  dialogSheet.getRange("D1").setValue(
    "–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: " + Utilities.formatDate(now, ss.getSpreadsheetTimeZone(), "dd.MM.yyyy HH:mm")
  );

  formatDialogSheet();
  var endTime = new Date();
  var duration = (endTime - startTime) / 1000;
  writeLog("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –°–µ—Å—Å–∏–π: " + sessionsProcessed + ". –í—Ä–µ–º—è: " + duration + " —Å–µ–∫.");

  // –ï—Å–ª–∏ API –∞–∫—Ç–∏–≤–µ–Ω ‚Äî –∑–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É
  if (isApiRunning()) {
    writeLog("API –∞–∫—Ç–∏–≤–µ–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º processApiMessagesSequential...");
    processApiMessagesSequential(true);
  }
}

/**
 * –û–±–Ω–æ–≤–ª—è–µ—Ç/–¥–æ–±–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è chatID –≤ –ª–∏—Å—Ç–µ "–î–∏–∞–ª–æ–≥–∏".
 * –î–æ–±–∞–≤–ª—è–µ—Ç –º–∞—Ä–∫–µ—Ä "[–°–æ–±—Ä–∞–Ω ...]" –≤ –Ω–∞—á–∞–ª–æ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç.
 * –ü–†–ê–í–ò–õ–¨–ù–û –î–û–ë–ê–í–õ–Ø–ï–¢ –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –¥–ª—è –æ–¥–Ω–æ–≥–æ chatID.
 * –¢–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç —Å chatID –≤ —Ñ–æ—Ä–º–∞—Ç–µ "418838097 (@well_sh)"
 */
function updateDialogSheetForChatID(finalChatID, newData) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var dialogSheet = getDialogSheet();

  if (dialogSheet.getLastRow() < 1) {
    dialogSheet.getRange("A1").setValue("ChatID");
  }

  var dates = Object.keys(newData);
  dates.sort();

  var lastRow = dialogSheet.getLastRow();
  var chatIDValues = [];
  if (lastRow >= 2) {
    chatIDValues = dialogSheet.getRange(2, 1, lastRow - 1, 1).getValues();
  }

  // –ò—â–µ–º —Å—Ç—Ä–æ–∫—É —Å –Ω—É–∂–Ω—ã–º chatID
  var rowIndex = 0;
  for (var i = 0; i < chatIDValues.length; i++) {
    if (chatIDValues[i][0] == finalChatID) {
      rowIndex = i + 2;
      break;
    }
  }

  // –ï—Å–ª–∏ chatID –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É
  if (rowIndex === 0) {
    rowIndex = dialogSheet.getLastRow() + 1;
    dialogSheet.getRange(rowIndex, 1).setValue(finalChatID);
    writeLog("–°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è ChatID: " + finalChatID, "INFO");
  } else {
    writeLog("–ù–∞–π–¥–µ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è ChatID: " + finalChatID + " (—Å—Ç—Ä–æ–∫–∞ " + rowIndex + ")", "INFO");
  }

  var now = new Date();
  var collectTimeStr = Utilities.formatDate(now, ss.getSpreadsheetTimeZone(), "dd.MM.yyyy HH:mm:ss");
  var collectMarker = "[–°–æ–±—Ä–∞–Ω " + collectTimeStr + "]\n\n";

  // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é –¥–∞—Ç—É –∏–∑ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
  for (var i = 0; i < dates.length; i++) {
    var dateStr = dates[i];
    var colIndex = i + 2; 
    var cell = dialogSheet.getRange(rowIndex, colIndex);
    var currentContent = cell.getValue();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤ —è—á–µ–π–∫–µ
    if (currentContent && currentContent.toString().trim() !== "") {
      writeLog("–î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —è—á–µ–π–∫–µ –¥–ª—è ChatID " + finalChatID + ", –¥–∞—Ç–∞ " + dateStr, "INFO");
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ —Ç–µ–∫—É—â–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç–µ –º–∞—Ä–∫–µ—Ä "[–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –ò–ò]"
      var isProcessed = currentContent.toString().indexOf("[–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –ò–ò]") !== -1;
      
      if (isProcessed) {
        // –ï—Å–ª–∏ —è—á–µ–π–∫–∞ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –ò–ò, –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        writeLog("–Ø—á–µ–π–∫–∞ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –ò–ò, –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞", "INFO");
        
        // –ò—â–µ–º, –≥–¥–µ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π –ò–ò –∫–æ–Ω—Ç–µ–Ω—Ç
        var processedContent = currentContent.toString();
        var lastContainerData = processedContent + "\n\n" + collectMarker + newData[dateStr];
        cell.setValue(lastContainerData);
      } else {
        // –Ø—á–µ–π–∫–∞ –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –ò–ò, –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –º–∞—Ä–∫–µ—Ä [–°–æ–±—Ä–∞–Ω]
        if (currentContent.toString().indexOf("[–°–æ–±—Ä–∞–Ω ") === -1) {
          // –ï—Å–ª–∏ –Ω–µ—Ç –º–∞—Ä–∫–µ—Ä–∞, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ
          cell.setValue(collectMarker + currentContent + "\n\n" + newData[dateStr]);
        } else {
          // –ú–∞—Ä–∫–µ—Ä —É–∂–µ –µ—Å—Ç—å, –¥–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
          cell.setValue(currentContent + "\n\n" + newData[dateStr]);
        }
      }
    } else {
      // –Ø—á–µ–π–∫–∞ –±—ã–ª–∞ –ø—É—Å—Ç–æ–π, –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Å –º–∞—Ä–∫–µ—Ä–æ–º
      writeLog("–°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —è—á–µ–π–∫—É –¥–ª—è ChatID " + finalChatID + ", –¥–∞—Ç–∞ " + dateStr, "INFO");
      cell.setValue(collectMarker + newData[dateStr]);
    }
  }
}

/**
 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–ª–∏ —Å–æ–∑–¥–∞—ë—Ç –ª–∏—Å—Ç "–î–∏–∞–ª–æ–≥–∏".
 */
function getDialogSheet() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var dialogSheet = ss.getSheetByName("–î–∏–∞–ª–æ–≥–∏");
  if (!dialogSheet) {
    dialogSheet = ss.insertSheet("–î–∏–∞–ª–æ–≥–∏");
    dialogSheet.getRange("A1").setValue("ChatID");
    dialogSheet.getRange("B1").setValue("ID –±–æ—Ç–∞");
    dialogSheet.getRange("C1").setValue("API —Ç–æ–∫–µ–Ω");
    dialogSheet.getRange("D1").setValue("–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ");
    dialogSheet.getRange("E1").setValue("API –æ–±—Ä–∞–±–æ—Ç—á–∏–∫: –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω");
    dialogSheet.getRange("E1").setBackground("#ffe6e6").setFontWeight("bold");

    PropertiesService.getScriptProperties().setProperty('API_RUNNING', 'false');
    writeLog("–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –ª–∏—Å—Ç '–î–∏–∞–ª–æ–≥–∏'");
  }
  return dialogSheet;
}

/**
 * –û—á–∏—â–∞–µ—Ç chatID, –æ—Å—Ç–∞–≤–ª—è—è —á–∏—Å–ª–æ –º–µ–∂–¥—É "tb" –∏ "_".
 */
function cleanChatID(rawChatID) {
  var cleaned = rawChatID;
  if (typeof cleaned === "string" && cleaned.indexOf("tb") === 0) {
    var underscoreIndex = cleaned.indexOf("_");
    if (underscoreIndex !== -1) {
      cleaned = cleaned.substring(2, underscoreIndex);
    }
  }
  return cleaned;
}

/**
 * –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫ –ª–∏—Å—Ç—É "–î–∏–∞–ª–æ–≥–∏".
 */
function formatDialogSheet() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName("–î–∏–∞–ª–æ–≥–∏");
  if (!sheet) return;

  var dataRange = sheet.getDataRange();
  dataRange.setWrap(true);
  dataRange.setBorder(true, true, true, true, true, true);

  var numCols = dataRange.getNumColumns();
  var numRows = dataRange.getNumRows();
  var allRange = sheet.getRange(1, 1, numRows, numCols);
  allRange.setHorizontalAlignment("center");

  var chatIDRange = sheet.getRange(1, 1, numRows, 1);
  chatIDRange.setHorizontalAlignment("left");
  chatIDRange.setFontWeight("bold");
  chatIDRange.setBackground("#f0f0f0");

  if (numRows >= 1 && numCols >= 5) {
    var headerRow = sheet.getRange(1, 1, 1, 5);
    headerRow.setFontWeight("bold").setBackground("#e6f2ff");
  }

  sheet.setColumnWidth(1, 150);
  sheet.setColumnWidth(2, 200);
  sheet.setColumnWidth(3, 300);
  sheet.setColumnWidth(4, 250);
  sheet.setColumnWidth(5, 200);

  for (var i = 7; i <= numCols; i++) {
    sheet.autoResizeColumn(i);
  }
  allRange.setFontFamily("Arial").setFontSize(10);

  writeLog("–ü—Ä–∏–º–µ–Ω–µ–Ω–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫ –ª–∏—Å—Ç—É '–î–∏–∞–ª–æ–≥–∏'");
}

/**
 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–ª–∏ —Å–æ–∑–¥–∞—ë—Ç –ª–∏—Å—Ç "–õ–æ–≥–∏ —Å–∫—Ä–∏–ø—Ç–∞".
 */
function getLogSheet() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var logSheet = ss.getSheetByName("–õ–æ–≥–∏ —Å–∫—Ä–∏–ø—Ç–∞");
  if (!logSheet) {
    logSheet = ss.insertSheet("–õ–æ–≥–∏ —Å–∫—Ä–∏–ø—Ç–∞");
    logSheet.getRange("A1:D1").setValues([["–í—Ä–µ–º—è", "–£—Ä–æ–≤–µ–Ω—å", "–°–æ–æ–±—â–µ–Ω–∏–µ", "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ"]]);
    logSheet.getRange("A1:D1").setBackground("#4285F4").setFontColor("white").setFontWeight("bold");
    logSheet.setFrozenRows(1);

    logSheet.setColumnWidth(1, 180);
    logSheet.setColumnWidth(2, 90);
    logSheet.setColumnWidth(3, 400);
    logSheet.setColumnWidth(4, 200);

    Logger.log("–°–æ–∑–¥–∞–Ω –ª–∏—Å—Ç '–õ–æ–≥–∏ —Å–∫—Ä–∏–ø—Ç–∞'");
  }
  return logSheet;
}

/**
 * –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ª–∏—Å—Ç –ª–æ–≥–æ–≤.
 */
function writeLog(message, level, extra) {
  if (!level) level = "INFO";
  Logger.log("[" + level + "] " + message);

  try {
    var logSheet = getLogSheet();
    var now = new Date();
    var timestamp = Utilities.formatDate(
      now, 
      SpreadsheetApp.getActiveSpreadsheet().getSpreadsheetTimeZone(), 
      "dd.MM.yyyy HH:mm:ss"
    );

    logSheet.insertRowAfter(1);
    var logRow = [timestamp, level, message, extra || ""];
    logSheet.getRange(2, 1, 1, 4).setValues([logRow]);

    var levelCell = logSheet.getRange(2, 2);
    switch(level.toUpperCase()) {
      case "ERROR":
        levelCell.setBackground("#f4c7c3");
        break;
      case "WARNING":
        levelCell.setBackground("#fce8b2");
        break;
      case "DEBUG":
        levelCell.setBackground("#d9d2e9");
        break;
      default:
        levelCell.setBackground("#d9ead3");
    }

    var lastRow = logSheet.getLastRow();
    if (lastRow > 1000) {
      logSheet.deleteRows(1001, lastRow - 1000);
    }
  } catch (e) {
    Logger.log("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ –≤ –ª–æ–≥: " + e);
  }
}

/**
 * –û—á–∏—â–∞–µ—Ç –ª–∏—Å—Ç "–õ–æ–≥–∏ —Å–∫—Ä–∏–ø—Ç–∞", –∫—Ä–æ–º–µ —à–∞–ø–∫–∏.
 */
function clearLogs() {
  try {
    var logSheet = getLogSheet();
    var lastRow = logSheet.getLastRow();
    if (lastRow > 1) {
      logSheet.deleteRows(2, lastRow - 1);
    }
    writeLog("–õ–æ–≥–∏ —É—Å–ø–µ—à–Ω–æ –æ—á–∏—â–µ–Ω—ã");
    SpreadsheetApp.getUi().alert("–õ–æ–≥–∏", "–õ–æ–≥–∏ —É—Å–ø–µ—à–Ω–æ –æ—á–∏—â–µ–Ω—ã", SpreadsheetApp.getUi().ButtonSet.OK);
  } catch (e) {
    Logger.log("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –ª–æ–≥–æ–≤: " + e);
    SpreadsheetApp.getUi().alert("–û—à–∏–±–∫–∞", "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏: " + e, SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

/**
 * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–æ–ª—è API (B1=botId, C1=token).
 */
function initializeApiFields() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var dialogSheet = ss.getSheetByName("–î–∏–∞–ª–æ–≥–∏");
  if (!dialogSheet) {
    dialogSheet = getDialogSheet();
  }

  var b1Value = dialogSheet.getRange("B1").getValue();
  var c1Value = dialogSheet.getRange("C1").getValue();
  var e1Value = dialogSheet.getRange("E1").getValue();
  if (!b1Value || b1Value === "ID –±–æ—Ç–∞") {
    dialogSheet.getRange("B1").setValue("ID –±–æ—Ç–∞")
      .setFontWeight("bold").setBackground("#e6f2ff");
  }
  if (!c1Value || c1Value === "API —Ç–æ–∫–µ–Ω") {
    dialogSheet.getRange("C1").setValue("API —Ç–æ–∫–µ–Ω")
      .setFontWeight("bold").setBackground("#e6f2ff");
  }
  if (!e1Value) {
    dialogSheet.getRange("E1").setValue("API –æ–±—Ä–∞–±–æ—Ç—á–∏–∫: –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
      .setFontWeight("bold").setBackground("#ffe6e6");
  }
  formatDialogSheet();
  writeLog("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –ø–æ–ª—è –¥–ª—è API", "INFO");
}

/**
 * –ó–∞–ø—É—Å–∫–∞–µ—Ç API-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫.
 */
function startApiProcessing() {
  var ui = SpreadsheetApp.getUi();
  if (isApiRunning()) {
    ui.alert('API —É–∂–µ –∑–∞–ø—É—â–µ–Ω', 'API-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–∂–µ –∞–∫—Ç–∏–≤–µ–Ω.', ui.ButtonSet.OK);
    writeLog("–ü–æ–ø—ã—Ç–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ API, –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –∞–∫—Ç–∏–≤–µ–Ω", "WARNING");
    return;
  }

  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var dialogSheet = ss.getSheetByName("–î–∏–∞–ª–æ–≥–∏");
  if (!dialogSheet) {
    ui.alert('–û—à–∏–±–∫–∞', '–õ–∏—Å—Ç "–î–∏–∞–ª–æ–≥–∏" –Ω–µ –Ω–∞–π–¥–µ–Ω!', ui.ButtonSet.OK);
    writeLog("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å API: –ª–∏—Å—Ç '–î–∏–∞–ª–æ–≥–∏' –Ω–µ –Ω–∞–π–¥–µ–Ω", "ERROR");
    return;
  }

  var botId = getBotId();
  var apiToken = getApiToken();
  if (!botId || !apiToken) {
    ui.alert('–û—à–∏–±–∫–∞', '–£–∫–∞–∂–∏—Ç–µ ID –±–æ—Ç–∞ (B1) –∏ —Ç–æ–∫–µ–Ω (C1)!', ui.ButtonSet.OK);
    writeLog("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å API: –Ω–µ—Ç botId –∏–ª–∏ —Ç–æ–∫–µ–Ω–∞", "ERROR");
    return;
  }

  PropertiesService.getScriptProperties().setProperty('API_RUNNING', 'true');

  updateApiStatusDisplay();
  createApiTrigger();

  // –°—Ä–∞–∑—É –ø—Ä–æ–±—É–µ–º –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å
  processApiMessagesSequential(true);

  ui.alert('API –∑–∞–ø—É—â–µ–Ω', '–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω, –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π —Ä–µ–∂–∏–º.', ui.ButtonSet.OK);
  writeLog("API-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω (–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π —Ä–µ–∂–∏–º)", "INFO");
}

/**
 * –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç API-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫.
 */
function stopApiProcessing() {
  var ui = SpreadsheetApp.getUi();
  if (!isApiRunning()) {
    ui.alert('API –Ω–µ –∑–∞–ø—É—â–µ–Ω', '–ù–µ—á–µ–≥–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å.', ui.ButtonSet.OK);
    writeLog("–ü–æ–ø—ã—Ç–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ API", "WARNING");
    return;
  }

  PropertiesService.getScriptProperties().setProperty('API_RUNNING', 'false');
  
  var triggers = ScriptApp.getProjectTriggers();
  for (var i = 0; i < triggers.length; i++) {
    var fn = triggers[i].getHandlerFunction();
    if (fn === 'processApiMessages' || fn === 'processApiMessagesSequential' || fn === 'continueApiProcessingSequential') {
      ScriptApp.deleteTrigger(triggers[i]);
      writeLog("–£–¥–∞–ª—ë–Ω —Ç—Ä–∏–≥–≥–µ—Ä " + fn, "INFO");
    }
  }

  updateApiStatusDisplay();
  ui.alert('API –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', '–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.', ui.ButtonSet.OK);
  writeLog("API-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω", "INFO");
}

/**
 * –°–æ–∑–¥–∞—ë—Ç —Ç—Ä–∏–≥–≥–µ—Ä –¥–ª—è processApiMessagesSequential –∫–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç.
 */
function createApiTrigger() {
  var triggers = ScriptApp.getProjectTriggers();
  for (var i = 0; i < triggers.length; i++) {
    if (triggers[i].getHandlerFunction() === 'processApiMessagesSequential') {
      ScriptApp.deleteTrigger(triggers[i]);
    }
  }
  ScriptApp.newTrigger("processApiMessagesSequential")
    .timeBased()
    .everyMinutes(15)
    .create();
  writeLog("–°–æ–∑–¥–∞–Ω —Ç—Ä–∏–≥–≥–µ—Ä –¥–ª—è processApiMessagesSequential –∫–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç");
}

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∑–∞–ø—É—â–µ–Ω –ª–∏ API.
 */
function isApiRunning() {
  var apiRunning = PropertiesService.getScriptProperties().getProperty('API_RUNNING');
  return apiRunning === 'true';
}

/**
 * –û–±–Ω–æ–≤–ª—è–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ API –≤ —è—á–µ–π–∫–µ E1.
 */
function updateApiStatusDisplay() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var dialogSheet = ss.getSheetByName("–î–∏–∞–ª–æ–≥–∏");
  if (!dialogSheet) return;

  var running = isApiRunning();
  var statusCell = dialogSheet.getRange("E1");
  if (running) {
    statusCell.setValue("API –æ–±—Ä–∞–±–æ—Ç—á–∏–∫: –ó–∞–ø—É—â–µ–Ω (–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π)")
      .setFontWeight("bold")
      .setBackground("#e6ffe6");
  } else {
    statusCell.setValue("API –æ–±—Ä–∞–±–æ—Ç—á–∏–∫: –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
      .setFontWeight("bold")
      .setBackground("#ffe6e6");
  }
  writeLog("–°—Ç–∞—Ç—É—Å API –æ–±–Ω–æ–≤–ª—ë–Ω: " + (running ? "–ó–∞–ø—É—â–µ–Ω (–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π)" : "–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"), "INFO");
}

/**
 * –ü–æ–ª—É—á–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ ID –±–æ—Ç–∞ (–î–∏–∞–ª–æ–≥–∏!B1).
 */
function getBotId() {
  var dialogSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("–î–∏–∞–ª–æ–≥–∏");
  if (!dialogSheet) return "";
  return dialogSheet.getRange("B1").getValue().toString().trim();
}

/**
 * –ü–æ–ª—É—á–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ API —Ç–æ–∫–µ–Ω–∞ (–î–∏–∞–ª–æ–≥–∏!C1).
 */
function getApiToken() {
  var dialogSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("–î–∏–∞–ª–æ–≥–∏");
  if (!dialogSheet) return "";
  return dialogSheet.getRange("C1").getValue().toString().trim();
}

/**
 * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ API ChatForYou –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç.
 */
function sendMessageAndGetResponse(token, botId, chatId, messageId, message) {
  var url = "https://api.chatforyou.ru/api/v1.0/ask/" + token;
  var payload = {
    bot_id: Number(botId),
    chat_id: chatId,
    message_id: messageId,
    message: message
  };

  var options = {
    method: "post",
    contentType: "application/json",
    headers: {
      Authorization: "Bearer " + token
    },
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };

  try {
    var response = UrlFetchApp.fetch(url, options);
    var code = response.getResponseCode();
    var body = response.getContentText();
    if (code === 200) {
      var json = JSON.parse(body);
      var answer = json.done || json.response || null;
      return answer;
    } else {
      writeLog("API –≤–µ—Ä–Ω—É–ª –∫–æ–¥: " + code + " - " + body, "ERROR");
      return null;
    }
  } catch (e) {
    writeLog("–û—à–∏–±–∫–∞ –ø—Ä–∏ fetch: " + e.message, "ERROR");
    return null;
  }
}

/**
 * –ò–∑–≤–ª–µ–∫–∞–µ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –¥–∏–∞–ª–æ–≥ –∏–∑ —Ç–µ–∫—Å—Ç–∞ —Å –º–∞—Ä–∫–µ—Ä–æ–º [–°–æ–±—Ä–∞–Ω]
 * @param {string} text - –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç —Å –º–∞—Ä–∫–µ—Ä–æ–º
 * @return {string} - –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–π –¥–∏–∞–ª–æ–≥
 */
function extractOriginalDialog(text) {
  // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å –º–∞—Ä–∫–µ—Ä–∞ [–°–æ–±—Ä–∞–Ω]
  var sobranIndex = text.indexOf("[–°–æ–±—Ä–∞–Ω ");
  if (sobranIndex === -1) return text;
  
  // –ù–∞—Ö–æ–¥–∏–º –∫–æ–Ω–µ—Ü —Å—Ç—Ä–æ–∫–∏ —Å –º–∞—Ä–∫–µ—Ä–æ–º
  var endOfMarkerLine = text.indexOf("\n\n", sobranIndex);
  if (endOfMarkerLine === -1) return text.substring(sobranIndex + 1);
  
  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–∏–∞–ª–æ–≥ –ø–æ—Å–ª–µ –º–∞—Ä–∫–µ—Ä–∞
  return text.substring(endOfMarkerLine + 2);
}

/**
 * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —è—á–µ–π–∫–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ —Å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –∫–∞–∂–¥–æ–π.
 * –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –±–µ–∑ –ø—Ä–æ–≥—Ä–µ—Å—Å-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞.
 * –î–û–ë–ê–í–õ–ï–ù: ChatID –∏–∑ –∫–æ–ª–æ–Ω–∫–∏ A –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –Ω–∞—á–∞–ª–æ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ò–ò
 * @param {boolean} autoMode - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã
 * @param {number} startRow - –Ω–∞—á–∞–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ (–µ—Å–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É)
 * @param {number} startCol - –Ω–∞—á–∞–ª—å–Ω—ã–π —Å—Ç–æ–ª–±–µ—Ü (–µ—Å–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É)
 */
function processApiMessagesSequential(autoMode, startRow, startCol) {
  writeLog("=== –ù–∞—á–∞–ª–æ processApiMessagesSequential === (autoMode=" + autoMode +
           ", startRow=" + startRow + ", startCol=" + startCol + ")", "DEBUG");

  // –ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  startRow = startRow || 2;
  startCol = startCol || 2;

  if (!isApiRunning()) {
    writeLog("API –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω! –û–±—Ä–∞–±–æ—Ç–∫–∞ —è—á–µ–µ–∫ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è.", "INFO");
    return;
  }

  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var dialogSheet = ss.getSheetByName("–î–∏–∞–ª–æ–≥–∏");
  if (!dialogSheet) {
    writeLog("–õ–∏—Å—Ç '–î–∏–∞–ª–æ–≥–∏' –Ω–µ –Ω–∞–π–¥–µ–Ω. –û—Å—Ç–∞–Ω–æ–≤–∫–∞.", "ERROR");
    return;
  }

  var botId = dialogSheet.getRange("B1").getValue();
  var apiToken = dialogSheet.getRange("C1").getValue();
  if (!botId || !apiToken) {
    writeLog("–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç botId –∏–ª–∏ API-—Ç–æ–∫–µ–Ω –≤ B1/C1", "ERROR");
    return;
  }

  // –†–µ–≥—É–ª—è—Ä–∫–∞ "[–°–æ–±—Ä–∞–Ω DD.MM.YYYY HH:MM:SS]"
  var sobranRegex = /\[–°–æ–±—Ä–∞–Ω\s\d{2}\.\d{2}\.\d{4}\s\d{2}:\d{2}:\d{2}\]/;
  
  // –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –ª–∏—Å—Ç–∞
  var lastRow = dialogSheet.getLastRow();
  var lastCol = dialogSheet.getLastColumn();
  
  writeLog("–†–∞–∑–º–µ—Ä—ã –ª–∏—Å—Ç–∞: " + lastRow + " —Å—Ç—Ä–æ–∫, " + lastCol + " —Å—Ç–æ–ª–±—Ü–æ–≤", "DEBUG");
  
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–¥–Ω–æ–π —è—á–µ–π–∫–∏
  var cellProcessed = false;
  var foundCellToProcess = false;
  
  // –¶–∏–∫–ª –ø–æ —Å—Ç—Ä–æ–∫–∞–º (1-based)
  outerLoop:
  for (var row = startRow; row <= lastRow; row++) {
    // –¶–∏–∫–ª –ø–æ —Å—Ç–æ–ª–±—Ü–∞–º
    for (var col = (row === startRow ? startCol : 2); col <= lastCol; col++) {
      var cellValue = dialogSheet.getRange(row, col).getValue();
      if (!cellValue || cellValue.toString().trim() === "") {
        continue;
      }

      var cellText = cellValue.toString();
      if (!sobranRegex.test(cellText)) {
        continue;
      }
      if (cellText.indexOf("[–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –ò–ò]") !== -1) {
        continue;
      }

      // –ù–∞—à–ª–∏ —è—á–µ–π–∫—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
      foundCellToProcess = true;
      writeLog("–ù–∞–π–¥–µ–Ω–∞ —è—á–µ–π–∫–∞ (" + row + "," + col + "), –æ—Ç–ø—Ä–∞–≤–∫–∞...", "INFO");
      
      // –ù–û–í–û–ï: –ü–æ–ª—É—á–∞–µ–º ChatID –∏–∑ –∫–æ–ª–æ–Ω–∫–∏ A (—Å—Ç–æ–ª–±–µ—Ü 1) —Ç–æ–π –∂–µ —Å—Ç—Ä–æ–∫–∏
      var chatIDFromColumnA = dialogSheet.getRange(row, 1).getValue();
      var chatIDPrefix = "";
      if (chatIDFromColumnA && chatIDFromColumnA.toString().trim() !== "" && chatIDFromColumnA.toString().trim() !== "ChatID") {
        chatIDPrefix = "ChatID: " + chatIDFromColumnA.toString().trim() + "\n\n";
        writeLog("–î–æ–±–∞–≤–ª–µ–Ω –ø—Ä–µ—Ñ–∏–∫—Å ChatID –∏–∑ –∫–æ–ª–æ–Ω–∫–∏ A: " + chatIDFromColumnA, "DEBUG");
      }
      
      var chatId = "cell_r" + row + "c" + col + "_" + new Date().getTime();
      var messageId = "msg_" + new Date().getTime();
      // –ù–û–í–û–ï: –î–æ–±–∞–≤–ª—è–µ–º ChatID –≤ –Ω–∞—á–∞–ª–æ –∑–∞–ø—Ä–æ—Å–∞
      var messageText = chatIDPrefix + cellText;

      try {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ —è—á–µ–π–∫–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
        dialogSheet.getRange(row, col).setBackground("#fff2cc"); // –ñ–µ–ª—Ç—ã–π - –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∏ –ø–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç
        var response = sendMessageAndGetResponse(apiToken, botId, chatId, messageId, messageText);
        if (response) {
          var now = new Date();
          var processedTimeStr = Utilities.formatDate(now, ss.getSpreadsheetTimeZone(), "dd.MM.yyyy HH:mm:ss");
          
          // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç –∏ –º–∞—Ä–∫–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏
          dialogSheet.getRange(row, col).setValue(
            "[–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –ò–ò " + processedTimeStr + "]\n" + response
          );
          dialogSheet.getRange(row, col).setBackground("#e6ffe6"); // –ó–µ–ª–µ–Ω—ã–π - —É—Å–ø–µ—à–Ω–æ

          cellProcessed = true;
          writeLog("‚úÖ –£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ —è—á–µ–π–∫–∞ (" + row + "," + col + ")", "INFO");
        } else {
          writeLog("‚ö†Ô∏è –ù–µ—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç API, —è—á–µ–π–∫–∞ (" + row + "," + col + ")", "WARNING");
          dialogSheet.getRange(row, col).setBackground("#fff2cc"); // –û—Å—Ç–∞–≤–ª—è–µ–º –∂–µ–ª—Ç—ã–π
        }
      } catch (err) {
        writeLog("‚ùå –û—à–∏–±–∫–∞ –≤ —è—á–µ–π–∫–µ (" + row + "," + col + "): " + err, "ERROR");
        dialogSheet.getRange(row, col).setBackground("#f4cccc"); // –ö—Ä–∞—Å–Ω—ã–π - –æ—à–∏–±–∫–∞
      }
      
      // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º —Å–ª–µ–¥—É—é—â—É—é –ø–æ–∑–∏—Ü–∏—é
      PropertiesService.getScriptProperties().setProperty('API_CONTINUE_ROW', row.toString());
      PropertiesService.getScriptProperties().setProperty('API_CONTINUE_COL', (col + 1).toString());
      
      // –û–±—Ä–∞–±–æ—Ç–∞–ª–∏ –æ–¥–Ω—É —è—á–µ–π–∫—É, –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ü–∏–∫–ª–æ–≤
      break outerLoop;
    }
  }
  
  // –ï—Å–ª–∏ –Ω–∞—à–ª–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∞–ª–∏ —è—á–µ–π–∫—É, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –Ω–∞–ø—Ä—è–º—É—é
  if (foundCellToProcess) {
    if (isApiRunning()) {
      var nextRow = parseInt(PropertiesService.getScriptProperties().getProperty('API_CONTINUE_ROW') || '2');
      var nextCol = parseInt(PropertiesService.getScriptProperties().getProperty('API_CONTINUE_COL') || '2');
      
      writeLog("–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–ª–µ–¥—É—é—â–µ–π —è—á–µ–π–∫–∏ (" + nextRow + "," + nextCol + ")", "INFO");
      
      // –í–º–µ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Ç—Ä–∏–≥–≥–µ—Ä–∞ –≤—ã–∑—ã–≤–∞–µ–º continueApiProcessingSequential –Ω–∞–ø—Ä—è–º—É—é
      // –≠—Ç–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É—Å–∫–æ—Ä–∏—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
      continueApiProcessingSequential();
    }
  } else {
    writeLog("–ù–µ –Ω–∞–π–¥–µ–Ω–æ —è—á–µ–µ–∫ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏. –ó–∞–≤–µ—Ä—à–∞–µ–º.", "INFO");
    // –û—á–∏—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏
    PropertiesService.getScriptProperties().deleteProperty('API_CONTINUE_ROW');
    PropertiesService.getScriptProperties().deleteProperty('API_CONTINUE_COL');
  }
  
  writeLog("=== –ö–æ–Ω–µ—Ü processApiMessagesSequential ===", "DEBUG");
}

/**
 * –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
 * –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
 */
function continueApiProcessingSequential() {
  if (!isApiRunning()) {
    writeLog("API –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω, –Ω–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º", "INFO");
    return;
  }
  
  var props = PropertiesService.getScriptProperties();
  var row = parseInt(props.getProperty('API_CONTINUE_ROW') || '2');
  var col = parseInt(props.getProperty('API_CONTINUE_COL') || '2');

  // –ë–µ–∑ –∑–∞–¥–µ—Ä–∂–∫–∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–ª–µ–¥—É—é—â–µ–π —è—á–µ–π–∫–∏
  try {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º try-catch, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –æ—à–∏–±–∫–∏ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
    processApiMessagesSequential(true, row, col);
  } catch (e) {
    writeLog("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏: " + e.message, "ERROR");
    
    // –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –∏–∑-–∑–∞ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è, 
    // —Å–æ–∑–¥–∞–µ–º —Ç—Ä–∏–≥–≥–µ—Ä –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
    var triggers = ScriptApp.getProjectTriggers();
    var hasExistingTrigger = false;
    
    for (var i = 0; i < triggers.length; i++) {
      if (triggers[i].getHandlerFunction() === 'continueApiProcessingSequential') {
        hasExistingTrigger = true;
        break;
      }
    }
    
    if (!hasExistingTrigger) {
      ScriptApp.newTrigger('continueApiProcessingSequential')
        .timeBased()
        .after(1000) // 1 —Å–µ–∫—É–Ω–¥–∞
        .create();
      writeLog("–°–æ–∑–¥–∞–Ω —Ç—Ä–∏–≥–≥–µ—Ä –¥–ª—è –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏", "INFO");
    }
  }
}

/**
 * –§—É–Ω–∫—Ü–∏—è-–æ–±—ë—Ä—Ç–∫–∞ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–æ–≤.
 */
function runUpdate() {
  updateDialogHistory();
  createTimeTriggerDialogs();
}

/**
 * –°–æ–∑–¥–∞—ë—Ç —Ç—Ä–∏–≥–≥–µ—Ä –¥–ª—è updateDialogHistory –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç, –µ—Å–ª–∏ –Ω–µ—Ç.
 */
function createTimeTriggerDialogs() {
  var triggers = ScriptApp.getProjectTriggers();
  var found = triggers.some(function(t) {
    return t.getHandlerFunction() === "updateDialogHistory";
  });
  if (!found) {
    ScriptApp.newTrigger("updateDialogHistory")
      .timeBased()
      .everyMinutes(10)
      .create();
    writeLog("–°–æ–∑–¥–∞–Ω —Ç—Ä–∏–≥–≥–µ—Ä –¥–ª—è updateDialogHistory (–∫–∞–∂–¥—ã–µ 10 –º–∏–Ω)");
  } else {
    writeLog("–¢—Ä–∏–≥–≥–µ—Ä updateDialogHistory —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç", "INFO");
  }
}

/**
 * –§—É–Ω–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ç–∞–±–ª–∏—Ü—ã. 
 * –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É —É–ø–æ–º–∏–Ω–∞–Ω–∏–π –±–æ—Ç–æ–≤ –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Ä—É—á–Ω–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏.
 */
function onOpen() {
  var ui = SpreadsheetApp.getUi();
  try {
    // –°–æ–∑–¥–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –º–µ–Ω—é
    ui.createMenu('–°–±–æ—Ä–∫–∞ –¥–∏–∞–ª–æ–≥–æ–≤')
      .addItem('üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è', 'showInstructions')
      .addItem('üì• –°–æ–±—Ä–∞—Ç—å –¥–∏–∞–ª–æ–≥–∏ (runUpdate)', 'runUpdate')
      .addItem('üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏', 'clearLogs')
      .addToUi();

    ui.createMenu('API –æ–±—Ä–∞–±–æ—Ç—á–∏–∫')
      .addItem('‚úÖ –í–∫–ª—é—á–∏—Ç—å API –æ–±—Ä–∞–±–æ—Ç—á–∏–∫', 'startApiProcessing')
      .addItem('‚ùå –í—ã–∫–ª—é—á–∏—Ç—å API –æ–±—Ä–∞–±–æ—Ç—á–∏–∫', 'stopApiProcessing')
      .addToUi();

    ui.createMenu('–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤')
      .addItem('üìä –û–±–Ω–æ–≤–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É', 'runAnalyticsUpdate')
      .addItem('üìà –û–±–Ω–æ–≤–∏—Ç—å –¥–∏–∞–≥—Ä–∞–º–º—ã', 'runCreateCharts')
      .addToUi();
      
    // –ú–µ–Ω—é –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏
    ui.createMenu('üì± Telegram –õ–∏–¥—ã')
      .addItem('‚úÖ –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–æ—Ç–ø—Ä–∞–≤–∫—É (–∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É)', 'createTelegramNotifierTrigger')
      .addItem('‚ùå –í—ã–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–æ—Ç–ø—Ä–∞–≤–∫—É', 'removeTelegramNotifierTrigger')
      .addSeparator()
      .addItem('üìä –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å', 'showTelegramNotifierStatus')
      .addItem('üñ±Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä—É—á–Ω—É—é', 'manualScanForLeads')
      .addSeparator()
      .addItem('üß™ –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Telegram', 'testTelegramConnection')
      .addToUi();
      
    // –í—Ä–µ–º–µ–Ω–Ω–æ–µ –º–µ–Ω—é –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Co-Pilot (–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏)
    ui.createMenu('‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Co-Pilot')
      .addItem('‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –±–æ—Ç–æ–≤', 'createInstalledTrigger')
      .addToUi();

    // –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    basicInitializeApiFields();
    simpleUpdateApiStatusDisplay();
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Co-Pilot
    try {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º/—Å–æ–∑–¥–∞–µ–º –ª–∏—Å—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫
      var settingsSheet = ensureSettingsSheetExists();
      Logger.log("–õ–∏—Å—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ Co-Pilot –ø—Ä–æ–≤–µ—Ä–µ–Ω");
    } catch (e) {
      Logger.log("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Co-Pilot: " + e);
    }
    
    Logger.log("–°–∫—Ä–∏–ø—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
  } catch (error) {
    Logger.log("–û—à–∏–±–∫–∞ –≤ onOpen: " + error);
  }
}

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∏–ª–∏ —Å–æ–∑–¥–∞–µ—Ç –ª–∏—Å—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ Co-Pilot.
 * @return {Sheet} –õ–∏—Å—Ç —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
 */
function ensureSettingsSheetExists() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var settingsSheet = ss.getSheetByName("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Co-Pilot");
  
  if (!settingsSheet) {
    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –ª–∏—Å—Ç
    settingsSheet = ss.insertSheet("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Co-Pilot");
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
    settingsSheet.getRange("A1:B1").setValues([["ID –±–æ—Ç–∞", "API —Ç–æ–∫–µ–Ω"]]);
    settingsSheet.getRange("A1:B1").setFontWeight("bold").setBackground("#4285F4").setFontColor("white");
    
    // –ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö
    settingsSheet.getRange("A2:B2").setValues([["1234567", "–≤–∞—à_—Ç–æ–∫–µ–Ω_–∑–¥–µ—Å—å"]]);
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    settingsSheet.setColumnWidth(1, 150);
    settingsSheet.setColumnWidth(2, 300);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
    settingsSheet.getRange("D1:F1").merge();
    settingsSheet.getRange("D1").setValue("–ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ –£–ü–û–ú–ò–ù–ê–ù–ò–ô –ë–û–¢–û–í");
    settingsSheet.getRange("D1").setFontWeight("bold").setBackground("#4285F4").setFontColor("white");
    
    var instructions = [
      ["1. –í–≤–µ–¥–∏—Ç–µ ID –±–æ—Ç–∞ –∏ —Ç–æ–∫–µ–Ω API –∏–∑ ChatForYou –≤ —Å—Ç–æ–ª–±—Ü—ã A –∏ B"],
      ["2. –í –ª—é–±–æ–π —è—á–µ–π–∫–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç: @botId –í–∞—à –∑–∞–ø—Ä–æ—Å –∫ –±–æ—Ç—É"],
      ["3. –ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç –≤—Å–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–∞–±–ª–∏—Ü—ã"],
      ["4. –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫–∏ –Ω–∞ —è—á–µ–π–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ {A1} –≤–Ω—É—Ç—Ä–∏ –∑–∞–ø—Ä–æ—Å–∞"],
      ["5. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ ## –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –æ–¥–Ω–æ–π —è—á–µ–π–∫–µ"]
    ];
    settingsSheet.getRange("D2:F6").setValues(instructions);
    
    Logger.log("–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –ª–∏—Å—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ Co-Pilot");
  }
  
  return settingsSheet;
}

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ç—Ä–∏–≥–≥–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É–ø–æ–º–∏–Ω–∞–Ω–∏–π –±–æ—Ç–æ–≤.
 * @return {boolean} true, –µ—Å–ª–∏ —Ç—Ä–∏–≥–≥–µ—Ä —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
 */
function checkBotMentionsTriggerStatus() {
  var triggers = ScriptApp.getProjectTriggers();
  for (var i = 0; i < triggers.length; i++) {
    var trigger = triggers[i];
    if (trigger.getHandlerFunction() === "processBotMentions" && 
        trigger.getEventType() === ScriptApp.EventType.ON_EDIT) {
      return true;
    }
  }
  return false;
}

/**
 * –£–ø—Ä–æ—â—ë–Ω–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª–µ–π (ID –±–æ—Ç–∞, —Ç–æ–∫–µ–Ω).
 */
function basicInitializeApiFields() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var dialogSheet = ss.getSheetByName("–î–∏–∞–ª–æ–≥–∏");
  if (!dialogSheet) {
    dialogSheet = getDialogSheet();
  }

  var b1Value = dialogSheet.getRange("B1").getValue();
  var c1Value = dialogSheet.getRange("C1").getValue();
  var e1Value = dialogSheet.getRange("E1").getValue();
  var f1Value = dialogSheet.getRange("F1").getValue();

  if (!b1Value || b1Value === "ID –±–æ—Ç–∞") {
    dialogSheet.getRange("B1").setValue("ID –±–æ—Ç–∞")
      .setFontWeight("bold").setBackground("#e6f2ff");
  }
  if (!c1Value || c1Value === "API —Ç–æ–∫–µ–Ω") {
    dialogSheet.getRange("C1").setValue("API —Ç–æ–∫–µ–Ω")
      .setFontWeight("bold").setBackground("#e6f2ff");
  }
  if (!e1Value) {
    dialogSheet.getRange("E1").setValue("API –æ–±—Ä–∞–±–æ—Ç—á–∏–∫: –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
      .setFontWeight("bold").setBackground("#ffe6e6");
  }
  if (!f1Value) {
    dialogSheet.getRange("F1").setValue("–ü—Ä–æ–≥—Ä–µ—Å—Å: 0 –∏–∑ 0 (0%)")
      .setFontWeight("bold").setBackground("#e6f2ff");
  }
  formatDialogSheet();
  Logger.log("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –ø–æ–ª—è API (basic)");
}

/**
 * –£–ø—Ä–æ—â—ë–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ API –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏.
 */
function simpleUpdateApiStatusDisplay() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var dialogSheet = ss.getSheetByName("–î–∏–∞–ª–æ–≥–∏");
  if (!dialogSheet) return;
  
  try {
    var running = isApiRunning();
    var statusCell = dialogSheet.getRange("E1");
    if (running) {
      statusCell.setValue("API –æ–±—Ä–∞–±–æ—Ç—á–∏–∫: –ó–∞–ø—É—â–µ–Ω (–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π)")
        .setFontWeight("bold")
        .setBackground("#e6ffe6");
      
    } else {
      statusCell.setValue("API –æ–±—Ä–∞–±–æ—Ç—á–∏–∫: –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
        .setFontWeight("bold")
        .setBackground("#ffe6e6");
    }
  } catch (error) {
    Logger.log("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞: " + error);
  }
}

/**
 * –ê–Ω–∞–ª–∏–∑ —Ç–æ–∫–µ–Ω–æ–≤
 */
function runAnalyticsUpdate() {
  var TokenAnalytics = {};
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≥—Ä—É–∂–µ–Ω –ª–∏ –º–æ–¥—É–ª—å TokenAnalytics
  try {
    // –ü—ã—Ç–∞–µ–º—Å—è –≤—ã–∑–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ –º–æ–¥—É–ª—è TokenAnalytics
    updateTokenAnalytics();
    writeLog("–ó–∞–ø—É—â–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤ –∏–∑ –º–æ–¥—É–ª—è TokenAnalytics");
  } catch (e) {
    // –ï—Å–ª–∏ –º–æ–¥—É–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    writeLog("–ú–æ–¥—É–ª—å TokenAnalytics –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω: " + e.message, "WARNING");
    SpreadsheetApp.getUi().alert(
      "–ú–æ–¥—É–ª—å TokenAnalytics",
      "–ú–æ–¥—É–ª—å –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. " +
      "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –º–æ–¥—É–ª—å TokenAnalytics.gs –¥–æ–±–∞–≤–ª–µ–Ω –≤ –ø—Ä–æ–µ–∫—Ç.",
      SpreadsheetApp.getUi().ButtonSet.OK
    );
  }
}

/**
 * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∏–∞–≥—Ä–∞–º–º
 */
function runCreateCharts() {
  try {
    // –ü—ã—Ç–∞–µ–º—Å—è –≤—ã–∑–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ –º–æ–¥—É–ª—è TokenAnalytics
    createAnalyticsCharts(false); // false –æ–∑–Ω–∞—á–∞–µ—Ç —Ä—É—á–Ω–æ–π —Ä–µ–∂–∏–º —Å –¥–∏–∞–ª–æ–≥–∞–º–∏
    writeLog("–ó–∞–ø—É—â–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∏–∞–≥—Ä–∞–º–º –∏–∑ –º–æ–¥—É–ª—è TokenAnalytics");
  } catch (e) {
    // –ï—Å–ª–∏ –º–æ–¥—É–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    writeLog("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –¥–∏–∞–≥—Ä–∞–º–º—ã: " + e.message, "ERROR");
    SpreadsheetApp.getUi().alert(
      "–û—à–∏–±–∫–∞ –¥–∏–∞–≥—Ä–∞–º–º",
      "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –¥–∏–∞–≥—Ä–∞–º–º—ã. " +
      "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –º–æ–¥—É–ª—å TokenAnalytics.gs –¥–æ–±–∞–≤–ª–µ–Ω –≤ –ø—Ä–æ–µ–∫—Ç.\n\n" +
      "–û—à–∏–±–∫–∞: " + e.message,
      SpreadsheetApp.getUi().ButtonSet.OK
    );
  }
}

function showInstructions() {
  var ui = SpreadsheetApp.getUi();
  var msg = 
    "–ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ –°–ö–†–ò–ü–¢–ê:\n\n" +
    "1. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è –≤ –ª–∏—Å—Ç–µ '–î–∏–∞–ª–æ–≥–∏':\n" +
    "   ‚Ä¢ B1 ‚Äî ID –±–æ—Ç–∞ –≤ —Å–∏—Å—Ç–µ–º–µ ChatForYou\n" +
    "   ‚Ä¢ C1 ‚Äî API —Ç–æ–∫–µ–Ω –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ ChatForYou\n\n" +
    "2. –î–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∏–∞–ª–æ–≥–æ–≤:\n" +
    "   ‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ '–°–æ–±—Ä–∞—Ç—å –¥–∏–∞–ª–æ–≥–∏' –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –õ–∏—Å—Ç1\n" +
    "   ‚Ä¢ –î–∏–∞–ª–æ–≥–∏ –≥—Ä—É–ø–ø–∏—Ä—É—é—Ç—Å—è –ø–æ ChatID –∏ –¥–∞—Ç–∞–º\n" +
    "   ‚Ä¢ ChatID —Ç–µ–ø–µ—Ä—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ: 418838097 (@username)\n\n" +
    "3. –î–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —á–µ—Ä–µ–∑ API ChatForYou:\n" +
    "   ‚Ä¢ –í–∫–ª—é—á–∏—Ç–µ API –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —á–µ—Ä–µ–∑ –º–µ–Ω—é\n" +
    "   ‚Ä¢ –°–∏—Å—Ç–µ–º–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —è—á–µ–π–∫–∏\n" +
    "   ‚Ä¢ ChatID –∏–∑ –∫–æ–ª–æ–Ω–∫–∏ A –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –Ω–∞—á–∞–ª–æ –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ò–ò\n" +
    "   ‚Ä¢ –¶–≤–µ—Ç–∞ —è—á–µ–µ–∫: –∂—ë–ª—Ç—ã–π - –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ, –∑–µ–ª—ë–Ω—ã–π - —É—Å–ø–µ—à–Ω–æ, –∫—Ä–∞—Å–Ω—ã–π - –æ—à–∏–±–∫–∞\n\n" +
    "4. –û—Ç–ø—Ä–∞–≤–∫–∞ –ª–∏–¥–æ–≤ –≤ Telegram:\n" +
    "   ‚Ä¢ –ú–µ–Ω—é 'üì± Telegram –õ–∏–¥—ã' ‚Üí '–í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–æ—Ç–ø—Ä–∞–≤–∫—É'\n" +
    "   ‚Ä¢ –°–∏—Å—Ç–µ–º–∞ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É —Å–∫–∞–Ω–∏—Ä—É–µ—Ç –ª–∏—Å—Ç '–î–∏–∞–ª–æ–≥–∏'\n" +
    "   ‚Ä¢ –ù–∞—Ö–æ–¥–∏—Ç —è—á–µ–π–∫–∏ —Å 'ü§ñ –ê–ù–ê–õ–ò–ó –û–¢ –ò–ò' –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ Telegram\n" +
    "   ‚Ä¢ –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –º–µ—Ç–∫–∞ '‚úÖ –õ–ò–î –û–¢–ü–†–ê–í–õ–ï–ù'\n\n" +
    "5. –î–ª—è —Ä–∞–±–æ—Ç—ã –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤:\n" +
    "   ‚Ä¢ –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª TokenAnalytics.gs –¥–æ–±–∞–≤–ª–µ–Ω –≤ –ø—Ä–æ–µ–∫—Ç\n" +
    "   ‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω—é '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤' –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏ –¥–∏–∞–≥—Ä–∞–º–º\n\n" +
    "6. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è - —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –±–æ—Ç–æ–≤:\n" +
    "   ‚Ä¢ –í —Å–∏—Å—Ç–µ–º–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –±–æ—Ç–æ–≤ ChatForYou\n" +
    "   ‚Ä¢ –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –±–æ—Ç–æ–≤ –Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–Ω–æ–º –ª–∏—Å—Ç–µ '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Co-Pilot'\n" +
    "   ‚Ä¢ –í –ª—é–±–æ–π —è—á–µ–π–∫–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç @botId –í–∞—à –∑–∞–ø—Ä–æ—Å\n" +
    "   ‚Ä¢ –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–∞–±–ª–∏—Ü—ã";
  
  ui.alert("–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é", msg, ui.ButtonSet.OK);
}

/******************************************************
 * –ö–æ–Ω–µ—Ü main.gs
 ******************************************************/
